#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æµ‹è¯•æ‰«æç»“æœæ•°æ®ç»“æ„
"""

import json
from datetime import datetime
from modules.scanner import ScanResult

def test_scanresult_structure():
    """æµ‹è¯•ScanResultæ•°æ®ç»“æ„"""
    print("ğŸ” æµ‹è¯•ScanResultæ•°æ®ç»“æ„...")
    
    # åˆ›å»ºç¤ºä¾‹å‘ç°é¡¹
    finding_example = {
        "type": "sql_injection",
        "name": "SQLæ³¨å…¥æ¼æ´",
        "description": "åœ¨ç™»å½•é¡µé¢å‘ç°SQLæ³¨å…¥æ¼æ´",
        "severity": "critical",
        "cvss_score": 9.0,
        "evidence": "å‚æ•°: username, è½½è·: ' OR '1'='1",
        "remediation": "ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢",
        "details": {
            "target": "example.com",
            "parameter": "username",
            "payload": "' OR '1'='1",
            "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
    }
    
    # åˆ›å»ºScanResultå¯¹è±¡
    result = ScanResult(
        target="example.com",
        scan_type="web",
        start_time=datetime.now().isoformat(),
        end_time=datetime.now().isoformat(),
        status="completed"
    )
    
    result.add_finding(finding_example)
    
    # è½¬æ¢ä¸ºå­—å…¸
    result_dict = result.to_dict()
    
    print("ğŸ“‹ ScanResultå¯¹è±¡ç»“æ„:")
    print(json.dumps(result_dict, indent=2, ensure_ascii=False))
    
    print("\nğŸ“‹ å‘ç°é¡¹ç»“æ„:")
    print(json.dumps(finding_example, indent=2, ensure_ascii=False))
    
    # æ£€æŸ¥å…³é”®å­—æ®µæ˜¯å¦å­˜åœ¨
    print("\nâœ… å…³é”®å­—æ®µæ£€æŸ¥:")
    print(f"  - target: {result_dict.get('target')}")
    print(f"  - findingsæ•°é‡: {len(result_dict.get('findings', []))}")
    
    if result_dict.get('findings'):
        finding = result_dict['findings'][0]
        print(f"  - finding.type: {finding.get('type')}")
        print(f"  - finding.name: {finding.get('name')}")
        print(f"  - finding.description: {finding.get('description')}")
        print(f"  - finding.severity: {finding.get('severity')}")
        print(f"  - finding.cvss_score: {finding.get('cvss_score')}")
        print(f"  - finding.evidence: {finding.get('evidence')}")
        print(f"  - finding.remediation: {finding.get('remediation')}")
        print(f"  - finding.details: {finding.get('details')}")

def test_port_scanner_finding():
    """æµ‹è¯•ç«¯å£æ‰«æå™¨å‘ç°é¡¹ç»“æ„"""
    print("\nğŸ” æµ‹è¯•ç«¯å£æ‰«æå™¨å‘ç°é¡¹ç»“æ„...")
    
    from modules.network.port_scanner import PortScanner
    
    # åˆ›å»ºé…ç½®
    config = {
        "network": {
            "default_ports": "80,443,8080"
        }
    }
    
    scanner = PortScanner(config)
    
    # åˆ›å»ºä¸€ä¸ªç«¯å£å‘ç°é¡¹
    finding = scanner._create_finding(
        target="example.com",
        port=80,
        service="http",
        protocol="tcp",
        banner="Apache/2.4.41"
    )
    
    print("ğŸ“‹ ç«¯å£æ‰«æå‘ç°é¡¹ç»“æ„:")
    print(json.dumps(finding, indent=2, ensure_ascii=False))
    
    print("\nâœ… å…³é”®å­—æ®µæ£€æŸ¥:")
    print(f"  - type: {finding.get('type')}")
    print(f"  - name: {finding.get('name')}")
    print(f"  - description: {finding.get('description')}")
    print(f"  - severity: {finding.get('severity')}")
    print(f"  - cvss_score: {finding.get('cvss_score')}")
    print(f"  - evidence: {finding.get('evidence')}")
    print(f"  - remediation: {finding.get('remediation')}")
    print(f"  - details: {finding.get('details', {})}")

def test_directory_buster_finding():
    """æµ‹è¯•ç›®å½•çˆ†ç ´å‘ç°é¡¹ç»“æ„"""
    print("\nğŸ” æµ‹è¯•ç›®å½•çˆ†ç ´å‘ç°é¡¹ç»“æ„...")
    
    from modules.web.directory_buster import DirectoryBuster
    
    # åˆ›å»ºé…ç½®
    config = {
        "web": {
            "directories_wordlist": "config/wordlists/directories.txt"
        },
        "scanning": {
            "timeout": 10
        }
    }
    
    scanner = DirectoryBuster(config)
    
    # åˆ›å»ºä¸€ä¸ªç›®å½•å‘ç°é¡¹
    result = {
        "url": "http://example.com/admin",
        "status_code": 200,
        "content_length": 1234,
        "headers": {"Server": "Apache"},
        "redirect_location": None
    }
    
    finding = scanner._create_finding(
        target="http://example.com",
        result=result
    )
    
    print("ğŸ“‹ ç›®å½•çˆ†ç ´å‘ç°é¡¹ç»“æ„:")
    print(json.dumps(finding, indent=2, ensure_ascii=False))

if __name__ == "__main__":
    print("ğŸš€ å¼€å§‹æµ‹è¯•æ‰«æç»“æœæ•°æ®ç»“æ„...")
    print("=" * 60)
    
    test_scanresult_structure()
    test_port_scanner_finding()
    test_directory_buster_finding()
    
    print("\n" + "=" * 60)
    print("âœ… æµ‹è¯•å®Œæˆï¼")