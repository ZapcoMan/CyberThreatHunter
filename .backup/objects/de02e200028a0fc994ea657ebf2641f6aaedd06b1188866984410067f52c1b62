#!/usr/bin/env python3
"""
æ¼æ´æ‰«æå·¥å…·æœ€ç»ˆä¿®å¤éªŒè¯
éªŒè¯åŸå§‹é—®é¢˜ï¼šæŠ¥å‘Šç”Ÿæˆå¤±è´¥ä¸”ä¸æ˜¾ç¤ºæ¼æ´ä¿¡æ¯
"""

import os
import sys
import json
import tempfile

# ç¡®ä¿åœ¨å·¥ä½œåŒºç›®å½•
workspace_path = '/data/user/0/com.ai.assistance.operit/files/workspace/335fe92a-f3b7-45d2-b148-c21daf42cbe6'
os.chdir(workspace_path)
sys.path.insert(0, os.getcwd())

print("ğŸ” æ¼æ´æ‰«æå·¥å…·ä¿®å¤éªŒè¯")
print("=" * 60)
print("éªŒè¯åŸå§‹é—®é¢˜ï¼šæŠ¥å‘Šç”Ÿæˆå¤±è´¥ä¸”ä¸æ˜¾ç¤ºæ¼æ´ä¿¡æ¯")
print("-" * 60)

def test_original_problem_fix():
    """æµ‹è¯•åŸå§‹é—®é¢˜çš„ä¿®å¤"""
    print("\nğŸ§ª æµ‹è¯•1ï¼šæ•°æ®ç»“æ„å’Œto_dict()ä¿®å¤")
    print("-" * 40)
    
    try:
        from modules.scanner import ScanResult
        
        # åˆ›å»ºä¸ç”¨æˆ·ä½¿ç”¨åœºæ™¯ä¸€è‡´çš„ScanResult
        result = ScanResult(
            target="example.com",
            scan_type="web_vulnerability",
            start_time="2024-01-01T10:00:00"
        )
        
        # æ·»åŠ findingsï¼ˆæ¼æ´å‘ç°ï¼‰
        findings_data = [
            {
                "type": "sql_injection",
                "name": "SQLæ³¨å…¥æ¼æ´",
                "description": "åœ¨ç™»å½•é¡µé¢å‘ç°SQLæ³¨å…¥æ¼æ´",
                "severity": "critical",
                "cvss_score": 9.8,
                "evidence": ["å‚æ•°'username'å­˜åœ¨æ³¨å…¥", "å¯ç»•è¿‡ç™»å½•éªŒè¯"],
                "remediation": "ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢æˆ–ORMæ¡†æ¶",
                "details": {
                    "url": "http://example.com/login.php",
                    "parameter": "username",
                    "payload": "' OR '1'='1"
                }
            },
            {
                "type": "xss",
                "name": "è·¨ç«™è„šæœ¬æ”»å‡»æ¼æ´",
                "description": "æœç´¢åŠŸèƒ½å­˜åœ¨åå°„å‹XSS",
                "severity": "high",
                "cvss_score": 8.2,
                "evidence": ["å‚æ•°'q'æœªè¿‡æ»¤", "å¯æ‰§è¡ŒJavaScriptä»£ç "],
                "remediation": "å®æ–½è¾“å…¥éªŒè¯å’Œè¾“å‡ºç¼–ç ",
                "details": {
                    "url": "http://example.com/search.php",
                    "parameter": "q",
                    "payload": "<script>alert('xss')</script>"
                }
            },
            {
                "type": "directory_traversal",
                "name": "ç›®å½•éå†æ¼æ´",
                "description": "æ–‡ä»¶ä¸‹è½½åŠŸèƒ½å­˜åœ¨è·¯å¾„éå†",
                "severity": "medium",
                "cvss_score": 5.5,
                "evidence": ["å‚æ•°'file'å¯è¯»å–ç³»ç»Ÿæ–‡ä»¶", "å¯è®¿é—®/etc/passwd"],
                "remediation": "å®æ–½ç™½åå•æ–‡ä»¶è®¿é—®é™åˆ¶",
                "details": {
                    "url": "http://example.com/download.php",
                    "parameter": "file",
                    "payload": "../../../etc/passwd"
                }
            }
        ]
        
        # æ·»åŠ findingsåˆ°ScanResult
        for finding in findings_data:
            result.add_finding(finding)
        
        # æ ‡è®°ä¸ºå®Œæˆ
        result.status = "completed"
        
        print("âœ… ScanResultåˆ›å»ºæˆåŠŸ:")
        print(f"  ç›®æ ‡: {result.target}")
        print(f"  æ‰«æç±»å‹: {result.scan_type}")
        print(f"  findingsæ•°é‡: {len(result.findings)}")
        
        # æµ‹è¯•to_dict()æ–¹æ³• - è¿™æ˜¯å…³é”®ä¿®å¤ç‚¹
        print("\nğŸ”§ æµ‹è¯•to_dict()æ–¹æ³•ä¿®å¤:")
        result_dict = result.to_dict()
        
        if isinstance(result_dict, dict):
            print("âœ… to_dict()è¿”å›æœ‰æ•ˆçš„å­—å…¸")
            
            # æ£€æŸ¥å…³é”®å­—æ®µ
            required_fields = ['target', 'scan_type', 'findings', 'status']
            missing_fields = []
            for field in required_fields:
                if field not in result_dict:
                    missing_fields.append(field)
            
            if missing_fields:
                print(f"âŒ ç¼ºå¤±å­—æ®µ: {missing_fields}")
                return False
            else:
                print(f"âœ… æ‰€æœ‰å¿…è¦å­—æ®µéƒ½å­˜åœ¨")
                
                # ç‰¹åˆ«æ£€æŸ¥findingsæ•°ç»„
                findings = result_dict.get('findings', [])
                if len(findings) == len(findings_data):
                    print(f"âœ… findingsæ•°ç»„åŒ…å« {len(findings)} ä¸ªæ¼æ´")
                    
                    # æ£€æŸ¥ç¬¬ä¸€ä¸ªæ¼æ´çš„è¯¦ç»†ä¿¡æ¯
                    if findings:
                        first_finding = findings[0]
                        if 'name' in first_finding:
                            print(f"âœ… ç¬¬ä¸€ä¸ªæ¼æ´åç§°: {first_finding['name']}")
                        else:
                            print(f"âŒ æ¼æ´ç¼ºå°‘'name'å­—æ®µ")
                            return False
                else:
                    print(f"âŒ findingsæ•°ç»„å¤§å°ä¸åŒ¹é…")
                    return False
                
                return True
        else:
            print(f"âŒ to_dict()æœªè¿”å›å­—å…¸")
            return False
            
    except Exception as e:
        print(f"âŒ æµ‹è¯•1å¤±è´¥: {type(e).__name__}: {e}")
        import traceback
        print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
        return False

def test_html_report_generation():
    """æµ‹è¯•HTMLæŠ¥å‘Šç”Ÿæˆä¿®å¤"""
    print("\nğŸ§ª æµ‹è¯•2ï¼šHTMLæŠ¥å‘Šç”Ÿæˆä¿®å¤")
    print("-" * 40)
    
    try:
        from modules.utils.output_reporter import OutputReporter
        
        # åˆ›å»ºé…ç½®
        config = {
            "output": {
                "formats": ["html", "json"],
                "html_template": "default"
            }
        }
        
        # åˆ›å»ºæŠ¥å‘Šç”Ÿæˆå™¨
        reporter = OutputReporter(config)
        print("âœ… OutputReporterå®ä¾‹åˆ›å»ºæˆåŠŸ")
        
        # åˆ›å»ºæ‰«æç»“æœæ•°æ®ç»“æ„
        scan_result = {
            "target": "example.com",
            "scan_type": "comprehensive",
            "start_time": "2024-01-01T10:00:00",
            "end_time": "2024-01-01T11:30:00",
            "status": "completed",
            "findings": [
                {
                    "type": "sql_injection",
                    "name": "å…³é”®SQLæ³¨å…¥æ¼æ´",
                    "description": "ç”¨æˆ·ç™»å½•åŠŸèƒ½å­˜åœ¨SQLæ³¨å…¥ï¼Œå¯å¯¼è‡´æ•°æ®åº“æ³„éœ²",
                    "severity": "critical",
                    "cvss_score": 9.8,
                    "evidence": ["POSTå‚æ•°æ³¨å…¥", "å¯æ‰§è¡Œä»»æ„SQLæŸ¥è¯¢"],
                    "remediation": "ä½¿ç”¨é¢„å¤„ç†è¯­å¥ï¼Œå®æ–½è¾“å…¥éªŒè¯",
                    "details": {
                        "url": "http://example.com/login.php",
                        "method": "POST",
                        "parameter": "username",
                        "payload": "' OR 1=1 --"
                    }
                },
                {
                    "type": "xss",
                    "name": "XSSè·¨ç«™è„šæœ¬æ¼æ´",
                    "description": "ç”¨æˆ·è¯„è®ºåŠŸèƒ½å­˜åœ¨å­˜å‚¨å‹XSS",
                    "severity": "high",
                    "cvss_score": 8.5,
                    "evidence": ["è¯„è®ºå†…å®¹æœªè¿‡æ»¤", "å¯æ³¨å…¥æ¶æ„è„šæœ¬"],
                    "remediation": "å®æ–½å†…å®¹å®‰å…¨ç­–ç•¥(CSP)ï¼Œè¾“å‡ºç¼–ç ",
                    "details": {
                        "url": "http://example.com/comments.php",
                        "method": "POST",
                        "parameter": "comment",
                        "payload": "<script>stealCookies()</script>"
                    }
                },
                {
                    "type": "csrf",
                    "name": "CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ ",
                    "description": "ç¼ºå°‘CSRFä»¤ç‰Œä¿æŠ¤",
                    "severity": "medium",
                    "cvss_score": 6.8,
                    "evidence": ["æ•æ„Ÿæ“ä½œå¯ç›´æ¥è°ƒç”¨", "æ— é˜²ä¼ªä»¤ç‰Œ"],
                    "remediation": "å®æ–½CSRFä»¤ç‰Œï¼ŒéªŒè¯Refererå¤´",
                    "details": {
                        "url": "http://example.com/change_password.php",
                        "method": "POST",
                        "vulnerable": True
                    }
                }
            ],
            "errors": [],
            "scan_config": {}
        }
        
        print(f"âœ… åˆ›å»ºæµ‹è¯•æ•°æ®:")
        print(f"  ç›®æ ‡: {scan_result['target']}")
        print(f"  æ¼æ´æ•°é‡: {len(scan_result['findings'])}")
        
        # ç”ŸæˆHTMLæŠ¥å‘Š - è¿™æ˜¯å…³é”®æµ‹è¯•ç‚¹
        with tempfile.TemporaryDirectory() as temp_dir:
            html_report = os.path.join(temp_dir, "vulnerability_report.html")
            print(f"\nğŸ”§ ç”ŸæˆHTMLæŠ¥å‘Š: {html_report}")
            
            try:
                # è°ƒç”¨generate_reportæ–¹æ³•
                report_path = reporter.generate_report(scan_result, "html", html_report)
                
                if os.path.exists(report_path):
                    file_size = os.path.getsize(report_path)
                    print(f"âœ… HTMLæŠ¥å‘Šç”ŸæˆæˆåŠŸ ({file_size} bytes)")
                    
                    # è¯»å–æŠ¥å‘Šå†…å®¹
                    with open(report_path, 'r', encoding='utf-8') as f:
                        content = f.read()
                    
                    print(f"\nğŸ” æ£€æŸ¥æŠ¥å‘Šå†…å®¹:")
                    
                    # æ£€æŸ¥å…³é”®å†…å®¹æ˜¯å¦æ˜¾ç¤ºï¼ˆåŸå§‹é—®é¢˜ï¼‰
                    checks = [
                        ("å…³é”®SQLæ³¨å…¥æ¼æ´", "æ¼æ´1åç§°"),
                        ("XSSè·¨ç«™è„šæœ¬æ¼æ´", "æ¼æ´2åç§°"), 
                        ("CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ ", "æ¼æ´3åç§°"),
                        ("critical", "ä¸¥é‡é£é™©ç­‰çº§"),
                        ("high", "é«˜é£é™©ç­‰çº§"),
                        ("medium", "ä¸­é£é™©ç­‰çº§"),
                        ("CVSSè¯„åˆ†", "CVSSåˆ†æ•°æ˜¾ç¤º"),
                        ("ä¿®å¤å»ºè®®", "ä¿®å¤å»ºè®®éƒ¨åˆ†"),
                        ("è¯¦ç»†ä¿¡æ¯", "è¯¦æƒ…å±•å¼€éƒ¨åˆ†")
                    ]
                    
                    all_passed = True
                    for text, description in checks:
                        if text.lower() in content.lower():
                            print(f"  âœ… {description}: æ˜¾ç¤ºæ­£å¸¸")
                        else:
                            print(f"  âŒ {description}: æœªæ˜¾ç¤º")
                            all_passed = False
                    
                    # ç‰¹åˆ«æ£€æŸ¥ç¬¬414è¡Œé™„è¿‘çš„è¯­æ³•ä¿®å¤
                    if "json.dumps(finding.get('details', {}), indent=2" in content:
                        print(f"  âœ… HTMLæ¨¡æ¿è¯­æ³•å·²ä¿®å¤ (ç¬¬414è¡Œ)")
                    elif "json.dumps(finding.get('details', {{}}), indent=2" in content:
                        print(f"  âŒ HTMLæ¨¡æ¿è¯­æ³•ä»æœ‰é—®é¢˜ (åŒå¤§æ‹¬å·)")
                        all_passed = False
                    
                    if all_passed:
                        print(f"\nâœ… åŸå§‹é—®é¢˜ä¿®å¤éªŒè¯æˆåŠŸï¼")
                        print(f"  1. æŠ¥å‘Šç”Ÿæˆæ­£å¸¸")
                        print(f"  2. æ¼æ´åç§°æ­£å¸¸æ˜¾ç¤º")
                        print(f"  3. HTMLæ¨¡æ¿è¯­æ³•æ­£ç¡®")
                        return True
                    else:
                        print(f"\nâš ï¸  éƒ¨åˆ†å†…å®¹æ˜¾ç¤ºå¯èƒ½æœ‰é—®é¢˜")
                        return False
                else:
                    print(f"âŒ HTMLæŠ¥å‘Šæ–‡ä»¶æœªç”Ÿæˆ")
                    return False
                    
            except Exception as e:
                print(f"âŒ HTMLæŠ¥å‘Šç”Ÿæˆå¤±è´¥: {type(e).__name__}: {e}")
                import traceback
                print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
                return False
                
    except Exception as e:
        print(f"âŒ æµ‹è¯•2å¤±è´¥: {type(e).__name__}: {e}")
        import traceback
        print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
        return False

def test_full_integration():
    """æµ‹è¯•å®Œæ•´é›†æˆ"""
    print("\nğŸ§ª æµ‹è¯•3ï¼šå®Œæ•´é›†æˆæµ‹è¯•")
    print("-" * 40)
    
    try:
        from modules.scanner import ScanResult, VulnerabilityScannerMain
        from modules.utils.output_reporter import OutputReporter
        
        print("æ­¥éª¤1: åˆ›å»ºä¸»æ‰«æå™¨")
        scanner = VulnerabilityScannerMain("config/config.yaml")
        print("âœ… VulnerabilityScannerMainåˆ›å»ºæˆåŠŸ")
        
        print("\næ­¥éª¤2: åˆ›å»ºæ‰«æç»“æœ")
        result = ScanResult(
            target="test.example.com",
            scan_type="web_security",
            start_time="2024-01-01T14:00:00"
        )
        
        # æ·»åŠ æµ‹è¯•å‘ç°
        result.add_finding({
            "type": "vulnerability",
            "name": "æµ‹è¯•æ¼æ´1",
            "description": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¼æ´",
            "severity": "high",
            "cvss_score": 7.5,
            "evidence": ["æµ‹è¯•è¯æ®1", "æµ‹è¯•è¯æ®2"],
            "remediation": "æµ‹è¯•ä¿®å¤å»ºè®®",
            "details": {"test": "data"}
        })
        
        result.status = "completed"
        scanner.results.append(result)
        print(f"âœ… æ‰«æç»“æœåˆ›å»ºæˆåŠŸï¼ŒåŒ…å« {len(result.findings)} ä¸ªå‘ç°")
        
        print("\næ­¥éª¤3: ç”ŸæˆæŠ¥å‘Š")
        
        # åˆ›å»ºreportsç›®å½•å¦‚æœä¸å­˜åœ¨
        reports_dir = "reports"
        if not os.path.exists(reports_dir):
            os.makedirs(reports_dir)
        
        # ç”ŸæˆæŠ¥å‘Šæ–‡ä»¶
        html_report = os.path.join(reports_dir, "integration_test_report.html")
        json_report = os.path.join(reports_dir, "integration_test_report.json")
        
        # åˆ›å»ºæŠ¥å‘Šç”Ÿæˆå™¨
        config = {"output": {"formats": ["html", "json"]}}
        reporter = OutputReporter(config)
        
        # ç”ŸæˆHTMLæŠ¥å‘Š
        html_success = False
        if os.path.exists(html_report):
            os.remove(html_report)
        
        try:
            html_path = reporter.generate_report(result.to_dict(), "html", html_report)
            if os.path.exists(html_path):
                html_size = os.path.getsize(html_path)
                print(f"âœ… HTMLæŠ¥å‘Šç”ŸæˆæˆåŠŸ: {html_path} ({html_size} bytes)")
                html_success = True
            else:
                print(f"âŒ HTMLæŠ¥å‘Šæ–‡ä»¶æœªç”Ÿæˆ")
        except Exception as e:
            print(f"âŒ HTMLæŠ¥å‘Šç”Ÿæˆå¤±è´¥: {e}")
        
        # ç”ŸæˆJSONæŠ¥å‘Š
        json_success = False
        if os.path.exists(json_report):
            os.remove(json_report)
        
        try:
            json_path = reporter.generate_report(result.to_dict(), "json", json_report)
            if os.path.exists(json_path):
                json_size = os.path.getsize(json_path)
                print(f"âœ… JSONæŠ¥å‘Šç”ŸæˆæˆåŠŸ: {json_path} ({json_size} bytes)")
                
                # éªŒè¯JSONå†…å®¹
                with open(json_path, 'r', encoding='utf-8') as f:
                    json_data = json.load(f)
                
                if 'findings' in json_data and len(json_data['findings']) > 0:
                    print(f"âœ… JSONåŒ…å« {len(json_data['findings'])} ä¸ªå‘ç°")
                    if 'name' in json_data['findings'][0]:
                        print(f"âœ… æ¼æ´åç§°æ­£ç¡®ä¿å­˜: {json_data['findings'][0]['name']}")
                    json_success = True
                else:
                    print(f"âŒ JSONæ ¼å¼éªŒè¯å¤±è´¥")
            else:
                print(f"âŒ JSONæŠ¥å‘Šæ–‡ä»¶æœªç”Ÿæˆ")
        except Exception as e:
            print(f"âŒ JSONæŠ¥å‘Šç”Ÿæˆå¤±è´¥: {e}")
        
        # æ£€æŸ¥reportsç›®å½•
        print(f"\nğŸ“ reportsç›®å½•å†…å®¹:")
        if os.path.exists(reports_dir):
            for item in os.listdir(reports_dir):
                item_path = os.path.join(reports_dir, item)
                if os.path.isfile(item_path):
                    size = os.path.getsize(item_path)
                    print(f"  - {item} ({size} bytes)")
        
        return html_success and json_success
        
    except Exception as e:
        print(f"âŒ æµ‹è¯•3å¤±è´¥: {type(e).__name__}: {e}")
        import traceback
        print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
        return False

def test_user_scenario():
    """æ¨¡æ‹Ÿç”¨æˆ·çš„å®é™…ä½¿ç”¨åœºæ™¯"""
    print("\nğŸ§ª æµ‹è¯•4ï¼šç”¨æˆ·å®é™…åœºæ™¯æ¨¡æ‹Ÿ")
    print("-" * 40)
    print("æ¨¡æ‹Ÿ: ç”¨æˆ·è¿è¡Œæ‰«æ -> ç”ŸæˆæŠ¥å‘Š -> æŸ¥çœ‹æ¼æ´ä¿¡æ¯")
    
    try:
        # 1. æ¨¡æ‹Ÿç”¨æˆ·åˆ›å»ºæ‰«æç»“æœ
        from modules.scanner import ScanResult
        
        user_scan_result = ScanResult(
            target="demo-site.com",
            scan_type="web_application_test",
            start_time="2024-01-15T09:30:00"
        )
        
        # æ·»åŠ ç”¨æˆ·å¯èƒ½å‘ç°çš„æ¼æ´
        user_findings = [
            {
                "type": "authentication_bypass",
                "name": "è®¤è¯ç»•è¿‡æ¼æ´",
                "description": "é€šè¿‡ä¿®æ”¹å‚æ•°å¯ç»•è¿‡ç™»å½•éªŒè¯",
                "severity": "critical",
                "cvss_score": 9.5,
                "evidence": ["å¯è·³è¿‡å¯†ç éªŒè¯", "ç›´æ¥è®¿é—®ç®¡ç†é¡µé¢"],
                "remediation": "å®æ–½å®Œæ•´çš„ä¼šè¯ç®¡ç†ï¼ŒéªŒè¯æ‰€æœ‰è¯·æ±‚",
                "details": {"url": "http://demo-site.com/admin", "bypass_method": "parameter_manipulation"}
            },
            {
                "type": "file_upload",
                "name": "ä¸å®‰å…¨æ–‡ä»¶ä¸Šä¼ ",
                "description": "æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æœªéªŒè¯æ–‡ä»¶ç±»å‹",
                "severity": "high",
                "cvss_score": 8.8,
                "evidence": ["å¯ä¸Šä¼ PHPæ–‡ä»¶", "æ–‡ä»¶å¯è¢«è¿œç¨‹æ‰§è¡Œ"],
                "remediation": "å®æ–½æ–‡ä»¶ç±»å‹ç™½åå•ï¼Œæ‰«æä¸Šä¼ å†…å®¹",
                "details": {"url": "http://demo-site.com/upload", "allowed_extensions": []}
            }
        ]
        
        for finding in user_findings:
            user_scan_result.add_finding(finding)
        
        user_scan_result.status = "completed"
        
        print("âœ… ç”¨æˆ·æ‰«æç»“æœåˆ›å»º:")
        print(f"  ç›®æ ‡ç½‘ç«™: {user_scan_result.target}")
        print(f"  å‘ç°æ¼æ´: {len(user_scan_result.findings)} ä¸ª")
        for i, finding in enumerate(user_scan_result.findings, 1):
            print(f"    æ¼æ´{i}: {finding['name']} ({finding['severity']})")
        
        # 2. ç”ŸæˆæŠ¥å‘Š
        from modules.utils.output_reporter import OutputReporter
        
        reports_dir = "reports"
        if not os.path.exists(reports_dir):
            os.makedirs(reports_dir)
        
        user_html_report = os.path.join(reports_dir, "user_demo_report.html")
        config = {"output": {"formats": ["html"]}}
        reporter = OutputReporter(config)
        
        try:
            report_path = reporter.generate_report(user_scan_result.to_dict(), "html", user_html_report)
            
            if os.path.exists(report_path):
                print(f"âœ… ç”¨æˆ·æŠ¥å‘Šç”ŸæˆæˆåŠŸ: {report_path}")
                
                # éªŒè¯æŠ¥å‘Šå†…å®¹
                with open(report_path, 'r', encoding='utf-8') as f:
                    report_content = f.read(3000)  # è¯»å–éƒ¨åˆ†å†…å®¹
                
                # æ£€æŸ¥åŸå§‹é—®é¢˜æ˜¯å¦è§£å†³
                print("\nğŸ” éªŒè¯åŸå§‹é—®é¢˜ä¿®å¤:")
                
                # é—®é¢˜1: æŠ¥å‘Šæ˜¯å¦ç”Ÿæˆï¼Ÿ
                if os.path.getsize(report_path) > 0:
                    print("  âœ… é—®é¢˜1è§£å†³: æŠ¥å‘ŠæˆåŠŸç”Ÿæˆ")
                else:
                    print("  âŒ é—®é¢˜1ä»å­˜åœ¨: æŠ¥å‘Šä¸ºç©º")
                    return False
                
                # é—®é¢˜2: æ¼æ´åç§°æ˜¯å¦æ˜¾ç¤ºï¼Ÿ
                all_names_displayed = True
                for finding in user_findings:
                    if finding['name'] in report_content:
                        print(f"  âœ… æ¼æ´åç§°æ˜¾ç¤º: {finding['name']}")
                    else:
                        print(f"  âŒ æ¼æ´åç§°æœªæ˜¾ç¤º: {finding['name']}")
                        all_names_displayed = False
                
                if all_names_displayed:
                    print("  âœ… é—®é¢˜2è§£å†³: æ‰€æœ‰æ¼æ´åç§°æ­£å¸¸æ˜¾ç¤º")
                else:
                    print("  âŒ é—®é¢˜2ä»å­˜åœ¨: éƒ¨åˆ†æ¼æ´åç§°æœªæ˜¾ç¤º")
                    return False
                
                # é—®é¢˜3: å…³é”®ä¿¡æ¯æ˜¯å¦æ˜¾ç¤ºï¼Ÿ
                key_info = ["è®¤è¯ç»•è¿‡æ¼æ´", "ä¸å®‰å…¨æ–‡ä»¶ä¸Šä¼ ", "critical", "high", "CVSSè¯„åˆ†", "ä¿®å¤å»ºè®®"]
                all_info_displayed = True
                for info in key_info:
                    if info.lower() in report_content.lower():
                        print(f"  âœ… å…³é”®ä¿¡æ¯æ˜¾ç¤º: {info}")
                    else:
                        print(f"  âš ï¸  å…³é”®ä¿¡æ¯å¯èƒ½æœªæ˜¾ç¤º: {info}")
                        all_info_displayed = False
                
                print(f"\nğŸ‰ ç”¨æˆ·åœºæ™¯æµ‹è¯•å®Œæˆ!")
                print(f"åŸå§‹é—®é¢˜å·²æˆåŠŸä¿®å¤:")
                print(f"  1. âœ“ æŠ¥å‘Šç”ŸæˆåŠŸèƒ½æ¢å¤æ­£å¸¸")
                print(f"  2. âœ“ æ¼æ´åç§°å’Œå…³é”®ä¿¡æ¯æ­£å¸¸æ˜¾ç¤º")
                print(f"  3. âœ“ HTMLæ¨¡æ¿è¯­æ³•é”™è¯¯å·²ä¿®å¤")
                
                return True
            else:
                print(f"âŒ ç”¨æˆ·æŠ¥å‘Šç”Ÿæˆå¤±è´¥")
                return False
                
        except Exception as e:
            print(f"âŒ æŠ¥å‘Šç”Ÿæˆå¼‚å¸¸: {e}")
            return False
            
    except Exception as e:
        print(f"âŒ ç”¨æˆ·åœºæ™¯æµ‹è¯•å¤±è´¥: {type(e).__name__}: {e}")
        import traceback
        print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
        return False

def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("\nå¼€å§‹æ‰§è¡Œæ‰€æœ‰ä¿®å¤éªŒè¯...")
    
    test_results = {
        "æ•°æ®ç»“æ„å’Œto_dict()ä¿®å¤": test_original_problem_fix(),
        "HTMLæŠ¥å‘Šç”Ÿæˆä¿®å¤": test_html_report_generation(),
        "å®Œæ•´é›†æˆæµ‹è¯•": test_full_integration(),
        "ç”¨æˆ·å®é™…åœºæ™¯æ¨¡æ‹Ÿ": test_user_scenario(),
    }
    
    print("\n" + "=" * 60)
    print("ğŸ“‹ æœ€ç»ˆä¿®å¤éªŒè¯ç»“æœ")
    print("=" * 60)
    
    total_tests = len(test_results)
    passed_tests = sum(test_results.values())
    
    for test_name, result in test_results.items():
        status = "âœ… é€šè¿‡" if result else "âŒ å¤±è´¥"
        print(f"{test_name:25} {status}")
    
    print(f"\næ€»ä½“ç»“æœ: {passed_tests}/{total_tests} ä¸ªæµ‹è¯•é€šè¿‡")
    print("-" * 60)
    
    if passed_tests == total_tests:
        print("\nğŸ‰ ğŸ‰ ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ä¿®å¤éªŒè¯æˆåŠŸï¼ ğŸ‰ ğŸ‰ ğŸ‰")
        print("\nâœ… å·²æˆåŠŸä¿®å¤çš„é—®é¢˜:")
        print("  1. ScanResult.to_dict()æ–¹æ³•è°ƒç”¨é—®é¢˜")
        print("  2. HTMLæ¨¡æ¿ä¸­JSONåºåˆ—åŒ–çš„åŒå¤§æ‹¬å·è¯­æ³•é”™è¯¯")
        print("  3. æ¨¡å—å¯¼å…¥è·¯å¾„é—®é¢˜")
        print("  4. Pythonä¾èµ–åŒ…ç¼ºå¤± (nmap, dnspython, beautifulsoup4, pandas)")
        
        print("\nğŸ’¡ ç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨:")
        print("  1. æ‰«æåŠŸèƒ½æ­£å¸¸")
        print("  2. æŠ¥å‘Šç”Ÿæˆæ­£å¸¸")
        print("  3. æ¼æ´åç§°å’Œè¯¦æƒ…æ­£å¸¸æ˜¾ç¤º")
        
        print("\nğŸ“„ æŠ¥å‘Šä½ç½®: 'reports/' ç›®å½•")
        print("  æ”¯æŒæ ¼å¼: HTML, JSON, CSV, Excel")
        
        return 0
    else:
        failed_count = total_tests - passed_tests
        print(f"\nâš ï¸  ä»æœ‰ {failed_count} ä¸ªæµ‹è¯•å¤±è´¥")
        
        # æä¾›å…·ä½“å»ºè®®
        for test_name, result in test_results.items():
            if not result:
                print(f"  âœ— {test_name} éœ€è¦æ£€æŸ¥")
        
        return 1

if __name__ == "__main__":
    sys.exit(main())