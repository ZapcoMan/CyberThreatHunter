#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å…¨é¢æ¼æ´æ‰«æå·¥å…· - ä¸»ç¨‹åºå…¥å£
é›†æˆç½‘ç»œæ‰«æã€Webæ¼æ´æ£€æµ‹ã€ç›®å½•çˆ†ç ´ã€å­åŸŸåæšä¸¾ç­‰åŠŸèƒ½
"""

import argparse
import sys
import json
from pathlib import Path
from datetime import datetime

# å¯¼å…¥ä¸»æ‰«æå™¨
from modules.scanner import VulnerabilityScannerMain, ScanResult


def print_banner():
    """æ‰“å°ç¨‹åºæ¨ªå¹…"""
    banner = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                å…¨é¢æ¼æ´æ‰«æå·¥å…· v1.0.0                       â•‘
â•‘                Comprehensive Vulnerability Scanner           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ åŠŸèƒ½:                                                        â•‘
â•‘   â€¢ ç«¯å£æ‰«æ (TCP/UDP)                                      â•‘
â•‘   â€¢ Webæ¼æ´æ£€æµ‹ (SQLæ³¨å…¥/XSS/å‘½ä»¤æ³¨å…¥)                      â•‘
â•‘   â€¢ ç›®å½•çˆ†ç ´ (éšè—æ–‡ä»¶/ç›®å½•å‘ç°)                            â•‘
â•‘   â€¢ å­åŸŸåæšä¸¾ (DNSè®°å½•æŸ¥è¯¢)                                â•‘
â•‘   â€¢ å¤šæ ¼å¼æŠ¥å‘Š (HTML/JSON/CSV/Excel)                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
    print(banner)


def load_targets_from_file(filepath: str) -> list:
    """
    ä»æ–‡ä»¶åŠ è½½ç›®æ ‡åˆ—è¡¨
    
    Args:
        filepath: æ–‡ä»¶è·¯å¾„
        
    Returns:
        list: ç›®æ ‡åˆ—è¡¨
    """
    targets = []
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith('#'):
                    targets.append(line)
        print(f"âœ… ä»æ–‡ä»¶åŠ è½½ {len(targets)} ä¸ªç›®æ ‡")
    except FileNotFoundError:
        print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {filepath}")
        sys.exit(1)
    except Exception as e:
        print(f"âŒ è¯»å–æ–‡ä»¶å¤±è´¥: {e}")
        sys.exit(1)
    
    return targets


def parse_scan_types(scan_arg: str) -> list:
    """
    è§£ææ‰«æç±»å‹å‚æ•°
    
    Args:
        scan_arg: æ‰«æç±»å‹å‚æ•°
        
    Returns:
        list: æ‰«æç±»å‹åˆ—è¡¨
    """
    if scan_arg == "all":
        return ["port", "directory", "vulnerability", "subdomain"]
    elif scan_arg == "network":
        return ["port", "subdomain"]
    elif scan_arg == "web":
        return ["directory", "vulnerability"]
    else:
        return [scan_arg]


def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(
        description="å…¨é¢æ¼æ´æ‰«æå·¥å…·",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ä½¿ç”¨ç¤ºä¾‹:
  # æ‰«æå•ä¸ªç›®æ ‡çš„æ‰€æœ‰æ¼æ´
  python main.py --target example.com --scan all
  
  # åªæ‰«æWebæ¼æ´
  python main.py --target example.com --scan web
  
  # æ‰«æå¤šä¸ªç›®æ ‡
  python main.py --targets targets.txt --scan all
  
  # è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
  python main.py --target example.com --config myconfig.yaml
  
  # ç”ŸæˆJSONæŠ¥å‘Š
  python main.py --target example.com --scan all --format json
  
  # æŒ‡å®šè¾“å‡ºè·¯å¾„
  python main.py --target example.com --output ./myreport.html
  
  # è®¾ç½®å¹¶å‘çº¿ç¨‹æ•°
  python main.py --target example.com --threads 100
        """
    )
    
    # ç›®æ ‡å‚æ•°ç»„
    target_group = parser.add_mutually_exclusive_group(required=True)
    target_group.add_argument("--target", type=str, help="å•ä¸ªæ‰«æç›®æ ‡ (IP/åŸŸå/URL)")
    target_group.add_argument("--targets", type=str, help="åŒ…å«å¤šä¸ªç›®æ ‡çš„æ–‡ä»¶è·¯å¾„")
    
    # æ‰«æå‚æ•°
    parser.add_argument("--scan", type=str, default="all",
                       choices=["all", "network", "web", "port", "directory", 
                               "vulnerability", "subdomain"],
                       help="æ‰«æç±»å‹ (é»˜è®¤: all)")
    
    # è¾“å‡ºå‚æ•°
    parser.add_argument("--output", type=str, help="æŠ¥å‘Šè¾“å‡ºè·¯å¾„")
    parser.add_argument("--format", type=str, default="html",
                       choices=["html", "json", "csv", "excel"],
                       help="æŠ¥å‘Šæ ¼å¼ (é»˜è®¤: html)")
    
    # é…ç½®å‚æ•°
    parser.add_argument("--config", type=str, default="config/config.yaml",
                       help="é…ç½®æ–‡ä»¶è·¯å¾„ (é»˜è®¤: config/config.yaml)")
    
    # æ€§èƒ½å‚æ•°
    parser.add_argument("--threads", type=int, help="å¹¶å‘çº¿ç¨‹æ•°")
    parser.add_argument("--timeout", type=int, help="è¶…æ—¶æ—¶é—´(ç§’)")
    
    # å…¶ä»–å‚æ•°
    parser.add_argument("--verbose", "-v", action="store_true",
                       help="è¯¦ç»†è¾“å‡ºæ¨¡å¼")
    parser.add_argument("--quiet", "-q", action="store_true",
                       help="å®‰é™æ¨¡å¼ï¼Œåªè¾“å‡ºé”™è¯¯")
    parser.add_argument("--no-banner", action="store_true",
                       help="ä¸æ˜¾ç¤ºæ¨ªå¹…")
    
    args = parser.parse_args()
    
    # æ˜¾ç¤ºæ¨ªå¹…
    if not args.no_banner:
        print_banner()
    
    # å‡†å¤‡ç›®æ ‡åˆ—è¡¨
    if args.target:
        targets = [args.target]
        print(f"ğŸ¯ æ‰«æç›®æ ‡: {args.target}")
    else:
        targets = load_targets_from_file(args.targets)
        print(f"ğŸ¯ æ‰«æ {len(targets)} ä¸ªç›®æ ‡")
    
    # è§£ææ‰«æç±»å‹
    scan_types = parse_scan_types(args.scan)
    print(f"ğŸ” æ‰«æç±»å‹: {', '.join(scan_types)}")
    
    # åˆ›å»ºæ‰«æå™¨
    try:
        scanner = VulnerabilityScannerMain(args.config)
        print("âœ… æ‰«æå™¨åˆå§‹åŒ–å®Œæˆ")
        
        # åº”ç”¨æ€§èƒ½å‚æ•°
        if args.threads:
            scanner.config["scanning"]["threads"] = args.threads
            print(f"âš¡ è®¾ç½®å¹¶å‘çº¿ç¨‹æ•°: {args.threads}")
        
        if args.timeout:
            scanner.config["scanning"]["timeout"] = args.timeout
            print(f"â±ï¸  è®¾ç½®è¶…æ—¶æ—¶é—´: {args.timeout}ç§’")
        
    except Exception as e:
        print(f"âŒ æ‰«æå™¨åˆå§‹åŒ–å¤±è´¥: {e}")
        sys.exit(1)
    
    # æ‰§è¡Œæ‰«æ
    print("\n" + "="*60)
    print("å¼€å§‹æ‰«æ...")
    print("="*60)
    
    start_time = datetime.now()
    
    try:
        if len(targets) == 1:
            # å•ä¸ªç›®æ ‡æ‰«æ
            result = scanner.scan(targets[0], scan_types)
            results = [result]
        else:
            # å¤šä¸ªç›®æ ‡å¹¶å‘æ‰«æ
            max_workers = args.threads if args.threads else scanner.config["scanning"].get("threads", 50)
            results = scanner.scan_multiple(targets, scan_types, max_workers)
        
    except KeyboardInterrupt:
        print("\nâš ï¸  æ‰«æè¢«ç”¨æˆ·ä¸­æ–­")
        sys.exit(0)
    except Exception as e:
        print(f"âŒ æ‰«æè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}")
        sys.exit(1)
    
    end_time = datetime.now()
    elapsed = (end_time - start_time).total_seconds()
    
    print("\n" + "="*60)
    print("æ‰«æå®Œæˆ!")
    print("="*60)
    print(f"â±ï¸  æ€»è€—æ—¶: {elapsed:.2f}ç§’")
    
    # ç”ŸæˆæŠ¥å‘Š
    successful_scans = 0
    total_findings = 0
    
    for result in results:
        if result.status == "completed":
            successful_scans += 1
            stats = result.calculate_stats()
            total_findings += stats["total_findings"]
            
            # ç”ŸæˆæŠ¥å‘Š
            try:
                report_path = scanner.generate_report(result, args.format, args.output)
                print(f"ğŸ“„ æŠ¥å‘Šå·²ç”Ÿæˆ: {report_path}")
            except Exception as e:
                print(f"âš ï¸  ç”ŸæˆæŠ¥å‘Šå¤±è´¥: {e}")
    
    # æ˜¾ç¤ºæ‘˜è¦
    print("\nğŸ“Š æ‰«ææ‘˜è¦:")
    print("-" * 40)
    print(f"æ€»æ‰«ææ•°: {len(results)}")
    print(f"æˆåŠŸ: {successful_scans}")
    print(f"å¤±è´¥: {len(results) - successful_scans}")
    print(f"æ€»å‘ç°æ•°: {total_findings}")
    
    if successful_scans > 0:
        # ç”Ÿæˆæ±‡æ€»æŠ¥å‘Šï¼ˆå¦‚æœæœ‰å¤šä¸ªæˆåŠŸæ‰«æï¼‰
        if successful_scans > 1:
            try:
                summary_path = f"reports/summary_{datetime.now().strftime('%Y%m%d_%H%M%S')}.html"
                successful_results = [r for r in results if r.status == "completed"]
                
                # ä½¿ç”¨æŠ¥å‘Šç”Ÿæˆå™¨åˆ›å»ºæ±‡æ€»æŠ¥å‘Š
                from modules.utils.output_reporter import OutputReporter
                reporter = OutputReporter(scanner.config)
                summary_path = reporter.generate_summary_report(
                    [r.to_dict() for r in successful_results], 
                    "html"
                )
                print(f"ğŸ“Š æ±‡æ€»æŠ¥å‘Š: {summary_path}")
            except Exception as e:
                print(f"âš ï¸  ç”Ÿæˆæ±‡æ€»æŠ¥å‘Šå¤±è´¥: {e}")
        
        # æ˜¾ç¤ºé£é™©åˆ†å¸ƒ
        print("\nâš ï¸  é£é™©åˆ†å¸ƒ:")
        print("-" * 40)
        
        severity_counts = {
            "critical": 0,
            "high": 0,
            "medium": 0,
            "low": 0,
            "info": 0
        }
        
        for result in results:
            if result.status == "completed":
                stats = result.calculate_stats()
                for severity in severity_counts:
                    severity_counts[severity] += stats.get(severity, 0)
        
        for severity, count in severity_counts.items():
            if count > 0:
                print(f"  {severity.upper():<10}: {count}")
    
    print("\n" + "="*60)
    print("æ‰«æç»“æŸã€‚è¯·æŸ¥çœ‹ç”Ÿæˆçš„æŠ¥å‘Šè·å–è¯¦ç»†ä¿¡æ¯ã€‚")
    print("="*60)
    
    # é”™è¯¯æŠ¥å‘Š
    errors_found = False
    for result in results:
        if result.errors:
            errors_found = True
            print(f"\nâŒ ç›®æ ‡ {result.target} çš„é”™è¯¯:")
            for error in result.errors:
                print(f"  - {error}")
    
    if errors_found:
        print("\nğŸ’¡ å»ºè®®æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé…ç½®æ–‡ä»¶ï¼Œç„¶åé‡è¯•ã€‚")
    
    # é€€å‡ºä»£ç 
    if successful_scans == 0:
        sys.exit(1)  # æ²¡æœ‰æˆåŠŸæ‰«æ
    elif total_findings == 0:
        sys.exit(0)  # æˆåŠŸä½†æœªå‘ç°æ¼æ´
    else:
        sys.exit(0)  # æˆåŠŸå¹¶å‘ç°æ¼æ´


def test_mode():
    """æµ‹è¯•æ¨¡å¼ï¼Œç”¨äºå¿«é€ŸéªŒè¯åŠŸèƒ½"""
    print("ğŸ”§ è¿›å…¥æµ‹è¯•æ¨¡å¼...")
    
    # åˆ›å»ºæµ‹è¯•é…ç½®
    test_config = {
        "scanning": {
            "timeout": 5,
            "threads": 10,
            "user_agent": "VulnerabilityScanner/Test"
        },
        "network": {
            "default_ports": "80,443,8080"
        },
        "web": {
            "directories_wordlist": "config/wordlists/directories.txt",
            "extensions": [".php", ".html", ".txt"]
        },
        "dns": {
            "subdomains_wordlist": "config/wordlists/subdomains.txt",
            "dns_servers": ["8.8.8.8"]
        },
        "output": {
            "report_dir": "reports",
            "default_format": "html"
        }
    }
    
    # æµ‹è¯•ç›®æ ‡
    test_target = "127.0.0.1"
    
    print(f"ğŸ¯ æµ‹è¯•ç›®æ ‡: {test_target}")
    print("ğŸ” æµ‹è¯•ç«¯å£æ‰«æ...")
    
    try:
        # æµ‹è¯•ç«¯å£æ‰«æå™¨
        from modules.network.port_scanner import PortScanner
        port_scanner = PortScanner(test_config)
        
        # åªæ‰«æå¸¸è§ç«¯å£
        findings = port_scanner.scan_with_socket(test_target, [80, 443, 8080, 22])
        
        if findings:
            print(f"âœ… å‘ç° {len(findings)} ä¸ªå¼€æ”¾ç«¯å£")
            for finding in findings[:3]:  # åªæ˜¾ç¤ºå‰3ä¸ª
                print(f"  - ç«¯å£ {finding['details']['port']}/{finding['details']['protocol']}")
        else:
            print("â„¹ï¸  æœªå‘ç°å¼€æ”¾ç«¯å£")
        
        print("\nğŸ‰ æµ‹è¯•å®Œæˆ!")
        
    except Exception as e:
        print(f"âŒ æµ‹è¯•å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    # æ£€æŸ¥æ˜¯å¦å¤„äºæµ‹è¯•æ¨¡å¼
    if len(sys.argv) == 1:
        # æ²¡æœ‰å‚æ•°æ—¶æ˜¾ç¤ºå¸®åŠ©
        print_banner()
        print("\nä½¿ç”¨æ–¹æ³•: python main.py --help æŸ¥çœ‹å¸®åŠ©")
        print("æµ‹è¯•æ¨¡å¼: python main.py --test")
        sys.exit(0)
    elif len(sys.argv) == 2 and sys.argv[1] == "--test":
        # æµ‹è¯•æ¨¡å¼
        test_mode()
    else:
        # æ­£å¸¸æ¨¡å¼
        main()
