#!/usr/bin/env python3
"""
æ¼æ´æ‰«æå·¥å…·å®Œæ•´é›†æˆæµ‹è¯•
æµ‹è¯•åŒ…å«ï¼š
1. æ¨¡å—å¯¼å…¥æµ‹è¯•
2. æ•°æ®ç»“æ„æµ‹è¯•
3. æŠ¥å‘Šç”Ÿæˆæµ‹è¯•
"""

import os
import sys
import tempfile
import json
import traceback

def test_module_imports():
    """æµ‹è¯•æ‰€æœ‰å…³é”®æ¨¡å—çš„å¯¼å…¥"""
    print("ğŸ§ª æ¨¡å—å¯¼å…¥æµ‹è¯•")
    print("-" * 50)
    
    modules_to_test = [
        ('nmap', 'python-nmap'),
        ('modules.scanner', 'ä¸»æ‰«æå™¨æ¨¡å—'),
        ('modules.port_scanner', 'ç«¯å£æ‰«ææ¨¡å—'),
        ('modules.vulnerability_scanner', 'æ¼æ´æ‰«ææ¨¡å—'),
        ('modules.directory_buster', 'ç›®å½•çˆ†ç ´æ¨¡å—'),
        ('modules.subdomain_enum', 'å­åŸŸåæšä¸¾æ¨¡å—'),
        ('modules.output_reporter', 'æŠ¥å‘Šç”Ÿæˆæ¨¡å—'),
    ]
    
    all_passed = True
    for module_name, description in modules_to_test:
        try:
            if '.' in module_name:
                # å¯¹äºæˆ‘ä»¬çš„è‡ªå®šä¹‰æ¨¡å—
                __import__(module_name)
            else:
                # å¯¹äºå¤–éƒ¨ä¾èµ–
                __import__(module_name)
            print(f"âœ… {module_name:30} - {description}")
        except ImportError as e:
            print(f"âŒ {module_name:30} - {description}: {e}")
            all_passed = False
    
    print(f"\nå¯¼å…¥æµ‹è¯•ç»“æœ: {'âœ… å…¨éƒ¨é€šè¿‡' if all_passed else 'âŒ å­˜åœ¨å¤±è´¥'}")
    return all_passed

def test_scan_result_structure():
    """æµ‹è¯•ScanResultæ•°æ®ç»“æ„"""
    print("\nğŸ“Š ScanResultæ•°æ®ç»“æ„æµ‹è¯•")
    print("-" * 50)
    
    try:
        from modules.scanner import ScanResult
        
        # åˆ›å»ºæµ‹è¯•æ•°æ®
        result = ScanResult(
            type="network_scan",
            name="ç«¯å£æ‰«ææµ‹è¯•",
            description="æµ‹è¯•ä¸»æœºç«¯å£æ‰«æ",
            severity="medium",
            cvss_score=5.5,
            evidence=["ç«¯å£22å¼€æ”¾", "ç«¯å£80å¼€æ”¾"],
            remediation="å…³é—­ä¸å¿…è¦çš„ç«¯å£",
            details={"ports": [22, 80], "services": ["ssh", "http"]}
        )
        
        # æµ‹è¯•to_dictæ–¹æ³•
        result_dict = result.to_dict()
        
        required_fields = [
            'type', 'name', 'description', 'severity', 
            'cvss_score', 'evidence', 'remediation', 'details'
        ]
        
        print("åˆ›å»ºScanResultå®ä¾‹æˆåŠŸ")
        print(f"ç±»å‹: {result.type}")
        print(f"åç§°: {result.name}")
        print(f"æè¿°: {result.description}")
        
        print("\næ£€æŸ¥to_dict()æ–¹æ³•:")
        for field in required_fields:
            if field in result_dict:
                print(f"âœ… {field}: {type(result_dict[field]).__name__}")
            else:
                print(f"âŒ ç¼ºå¤±å­—æ®µ: {field}")
        
        print(f"\nto_dict()æ•°æ®ç»“æ„:")
        print(json.dumps(result_dict, indent=2, ensure_ascii=False))
        
        return True
        
    except Exception as e:
        print(f"âŒ ScanResultæµ‹è¯•å¤±è´¥: {e}")
        print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
        return False

def test_report_generation():
    """æµ‹è¯•æŠ¥å‘Šç”ŸæˆåŠŸèƒ½"""
    print("\nğŸ“„ æŠ¥å‘Šç”Ÿæˆæµ‹è¯•")
    print("-" * 50)
    
    try:
        from modules.scanner import ScanResult
        from modules.output_reporter import ReportGenerator
        
        # åˆ›å»ºæŠ¥å‘Šç”Ÿæˆå™¨
        reporter = ReportGenerator()
        
        # åˆ›å»ºæµ‹è¯•æ‰«æç»“æœ
        test_results = [
            ScanResult(
                type="network_scan",
                name="ç«¯å£æ‰«ææµ‹è¯•1",
                description="æµ‹è¯•ä¸»æœºç«¯å£æ‰«æ",
                severity="high",
                cvss_score=7.5,
                evidence=["ç«¯å£22å¼€æ”¾(SSH)", "ç«¯å£3389å¼€æ”¾(RDP)"],
                remediation="å…³é—­ä¸å¿…è¦çš„ç«¯å£ï¼Œé…ç½®é˜²ç«å¢™è§„åˆ™",
                details={"target": "192.168.1.100", "open_ports": [22, 3389]}
            ).to_dict(),
            ScanResult(
                type="web_vulnerability",
                name="SQLæ³¨å…¥æ¼æ´",
                description="å‘ç°SQLæ³¨å…¥æ¼æ´",
                severity="critical",
                cvss_score=9.8,
                evidence=["å‚æ•°'id'å­˜åœ¨SQLæ³¨å…¥", "å¯æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢"],
                remediation="ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œå®æ–½è¾“å…¥éªŒè¯",
                details={"url": "http://test.com/login.php", "parameter": "id"}
            ).to_dict(),
            ScanResult(
                type="directory_discovery",
                name="æ•æ„Ÿç›®å½•å‘ç°",
                description="å‘ç°æ•æ„Ÿç›®å½•å’Œæ–‡ä»¶",
                severity="medium",
                cvss_score=5.5,
                evidence=["/adminå¯è®¿é—®", "/backup.zipå¯ä¸‹è½½"],
                remediation="ç§»é™¤æˆ–ä¿æŠ¤æ•æ„Ÿç›®å½•",
                details={"discovered": ["/admin", "/backup.zip"]}
            ).to_dict(),
        ]
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºæµ‹è¯•
        with tempfile.TemporaryDirectory() as temp_dir:
            print(f"ä½¿ç”¨ä¸´æ—¶ç›®å½•: {temp_dir}")
            
            # æµ‹è¯•HTMLæŠ¥å‘Š
            html_report = os.path.join(temp_dir, "test_report.html")
            print(f"\nç”ŸæˆHTMLæŠ¥å‘Š: {html_report}")
            success = reporter.generate_html_report(test_results, html_report)
            if success and os.path.exists(html_report):
                file_size = os.path.getsize(html_report)
                print(f"âœ… HTMLæŠ¥å‘Šç”ŸæˆæˆåŠŸ ({file_size} bytes)")
                
                # æ£€æŸ¥æŠ¥å‘Šå†…å®¹
                with open(html_report, 'r', encoding='utf-8') as f:
                    content = f.read()
                    if "æ¼æ´æ‰«ææŠ¥å‘Š" in content:
                        print("âœ… æŠ¥å‘Šæ ‡é¢˜æ­£ç¡®")
                    else:
                        print("âš ï¸  è­¦å‘Š: æŠ¥å‘Šæ ‡é¢˜å¯èƒ½ä¸æ­£ç¡®")
                        
                    # æ£€æŸ¥æ¼æ´åç§°æ˜¯å¦æ˜¾ç¤º
                    for result in test_results:
                        if result['name'] in content:
                            print(f"âœ… æ¼æ´ '{result['name']}' åœ¨æŠ¥å‘Šä¸­æ˜¾ç¤º")
                        else:
                            print(f"âš ï¸  è­¦å‘Š: æ¼æ´ '{result['name']}' å¯èƒ½æœªæ˜¾ç¤º")
            else:
                print(f"âŒ HTMLæŠ¥å‘Šç”Ÿæˆå¤±è´¥")
                return False
            
            # æµ‹è¯•JSONæŠ¥å‘Š
            json_report = os.path.join(temp_dir, "test_report.json")
            print(f"\nç”ŸæˆJSONæŠ¥å‘Š: {json_report}")
            success = reporter.generate_json_report(test_results, json_report)
            if success and os.path.exists(json_report):
                file_size = os.path.getsize(json_report)
                print(f"âœ… JSONæŠ¥å‘Šç”ŸæˆæˆåŠŸ ({file_size} bytes)")
                
                # éªŒè¯JSONæ ¼å¼
                with open(json_report, 'r', encoding='utf-8') as f:
                    json_data = json.load(f)
                    if 'scan_results' in json_data and len(json_data['scan_results']) == len(test_results):
                        print(f"âœ… JSONåŒ…å« {len(test_results)} ä¸ªæ‰«æç»“æœ")
                    else:
                        print(f"âš ï¸  JSONæ ¼å¼éªŒè¯è­¦å‘Š")
            else:
                print(f"âŒ JSONæŠ¥å‘Šç”Ÿæˆå¤±è´¥")
                return False
            
            print(f"\nğŸ“ æ£€æŸ¥reportsç›®å½•çŠ¶æ€:")
            reports_dir = "reports"
            if os.path.exists(reports_dir):
                print(f"âœ… reportsç›®å½•å­˜åœ¨")
                print(f"ç›®å½•å†…å®¹:")
                for item in os.listdir(reports_dir):
                    item_path = os.path.join(reports_dir, item)
                    size = os.path.getsize(item_path) if os.path.isfile(item_path) else 0
                    print(f"  - {item} ({size} bytes)")
            else:
                print(f"âš ï¸  reportsç›®å½•ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥")
                
        return True
        
    except Exception as e:
        print(f"âŒ æŠ¥å‘Šç”Ÿæˆæµ‹è¯•å¤±è´¥: {e}")
        print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
        return False

def test_main_scanner():
    """æµ‹è¯•ä¸»æ‰«æå™¨åŠŸèƒ½"""
    print("\nğŸ” ä¸»æ‰«æå™¨åŠŸèƒ½æµ‹è¯•")
    print("-" * 50)
    
    try:
        from modules.scanner import ScanResult, VulnerabilityScannerMain
        
        # åˆ›å»ºæ‰«æå™¨å®ä¾‹ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
        scanner = VulnerabilityScannerMain(test_mode=True)
        
        # æµ‹è¯•å•ä¸ªæ–¹æ³•
        methods_to_test = [
            ('generate_report', 'æŠ¥å‘Šç”Ÿæˆæ–¹æ³•'),
            ('export_results', 'ç»“æœå¯¼å‡ºæ–¹æ³•'),
            ('add_scan_results', 'æ·»åŠ æ‰«æç»“æœ'),
        ]
        
        for method_name, description in methods_to_test:
            if hasattr(scanner, method_name):
                print(f"âœ… {method_name:25} - {description}")
            else:
                print(f"âŒ {method_name:25} - {description}: æ–¹æ³•ä¸å­˜åœ¨")
        
        # åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ‰«æç»“æœ
        test_result = ScanResult(
            type="test",
            name="é›†æˆæµ‹è¯•",
            description="ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•",
            severity="info",
            cvss_score=0,
            evidence=["æµ‹è¯•é€šè¿‡"],
            remediation="æ— éœ€ä¿®å¤",
            details={"test": "success"}
        )
        
        print("\næµ‹è¯•æ·»åŠ æ‰«æç»“æœ:")
        scanner.add_scan_results([test_result])
        print(f"âœ… æ·»åŠ æ‰«æç»“æœæˆåŠŸ")
        print(f"å½“å‰æ‰«æç»“æœæ•°é‡: {len(scanner.scan_results)}")
        
        # æµ‹è¯•æŠ¥å‘Šç”Ÿæˆï¼ˆä¸å®é™…å†™å…¥æ–‡ä»¶ï¼‰
        print("\næµ‹è¯•generate_reportæ–¹æ³•:")
        try:
            # ä¼ é€’ScanResultå¯¹è±¡ï¼ˆä¹‹å‰ä¿®å¤çš„é—®é¢˜ï¼‰
            success = scanner.generate_report([test_result], "html", "test_temp_report.html")
            if success:
                print("âœ… generate_reportè°ƒç”¨æˆåŠŸ")
            else:
                print("âš ï¸  generate_reportè¿”å›False")
        except Exception as e:
            print(f"âŒ generate_reportè°ƒç”¨å¤±è´¥: {e}")
            
        return True
        
    except Exception as e:
        print(f"âŒ ä¸»æ‰«æå™¨æµ‹è¯•å¤±è´¥: {e}")
        print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
        return False

def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("ğŸ”¬ æ¼æ´æ‰«æå·¥å…·ç»¼åˆé›†æˆæµ‹è¯•")
    print("=" * 60)
    
    test_results = {
        "æ¨¡å—å¯¼å…¥": test_module_imports(),
        "æ•°æ®ç»“æ„": test_scan_result_structure(),
        "æŠ¥å‘Šç”Ÿæˆ": test_report_generation(),
        "ä¸»æ‰«æå™¨": test_main_scanner(),
    }
    
    print("\n" + "=" * 60)
    print("ğŸ“‹ æµ‹è¯•ç»“æœæ‘˜è¦")
    print("=" * 60)
    
    total_tests = len(test_results)
    passed_tests = sum(test_results.values())
    
    for test_name, result in test_results.items():
        status = "âœ… é€šè¿‡" if result else "âŒ å¤±è´¥"
        print(f"{test_name:15} {status}")
    
    print(f"\næ€»ä½“ç»“æœ: {passed_tests}/{total_tests} ä¸ªæµ‹è¯•é€šè¿‡")
    
    if passed_tests == total_tests:
        print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ¼æ´æ‰«æå·¥å…·ä¿®å¤æˆåŠŸï¼")
        print("\nğŸ’¡ ä¸‹ä¸€æ­¥å»ºè®®ï¼š")
        print("1. è¿è¡Œ `python main.py --target example.com --scan web` è¿›è¡ŒçœŸå®æµ‹è¯•")
        print("2. æ£€æŸ¥ç”Ÿæˆçš„HTMLæŠ¥å‘Šæ˜¯å¦å®Œæ•´æ˜¾ç¤ºæ¼æ´ä¿¡æ¯")
        print("3. æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´æ‰«æå‚æ•°å’ŒæŠ¥å‘Šæ¨¡æ¿")
        return 0
    else:
        print(f"\nâš ï¸  éœ€è¦ä¿®å¤ {total_tests - passed_tests} ä¸ªå¤±è´¥æµ‹è¯•")
        return 1

if __name__ == "__main__":
    sys.exit(main())