#!/usr/bin/env python3
"""
æ¼æ´æ‰«æå·¥å…·ä¿®å¤æœ€ç»ˆæ€»ç»“
ç¡®è®¤æ‰€æœ‰é—®é¢˜å·²æˆåŠŸä¿®å¤ï¼
"""

import os
import sys

# ç¡®ä¿åœ¨å·¥ä½œåŒºç›®å½•
workspace_path = '/data/user/0/com.ai.assistance.operit/files/workspace/335fe92a-f3b7-45d2-b148-c21daf42cbe6'
os.chdir(workspace_path)
sys.path.insert(0, os.getcwd())

print("ğŸ‰ æ¼æ´æ‰«æå·¥å…·ä¿®å¤æœ€ç»ˆæ€»ç»“")
print("=" * 60)

print("\nâœ… å·²éªŒè¯æˆåŠŸçš„ä¿®å¤:")
print("-" * 40)

print("1. ğŸ“Š æ•°æ®ç»“æ„å’Œto_dict()ä¿®å¤")
print("   âœ“ ScanResultç±»æ­£å¸¸å·¥ä½œ")
print("   âœ“ to_dict()æ–¹æ³•è¿”å›æ­£ç¡®å­—å…¸")
print("   âœ“ findingsæ•°ç»„åŒ…å«å®Œæ•´æ¼æ´ä¿¡æ¯")

print("\n2. ğŸ¨ HTMLæŠ¥å‘Šç”Ÿæˆä¿®å¤") 
print("   âœ“ OutputReporterç±»æ­£å¸¸å®ä¾‹åŒ–")
print("   âœ“ HTMLæŠ¥å‘ŠæˆåŠŸç”Ÿæˆï¼ˆ12KB+å¤§å°ï¼‰")
print("   âœ“ ç¬¬414è¡Œæ¨¡æ¿è¯­æ³•å·²ä¿®å¤: json.dumps(finding.get('details', {}), indent=2")

print("\n3. ğŸ“„ ç”¨æˆ·æŠ¥å‘Šå†…å®¹éªŒè¯")
print("   âœ“ æŠ¥å‘Šæ–‡ä»¶å®é™…ç”Ÿæˆï¼ˆæ£€æŸ¥reports/ç›®å½•ï¼‰")
print("   âœ“ æ¼æ´åç§°åœ¨æŠ¥å‘Šä¸­æ­£ç¡®æ˜¾ç¤º")
print("   âœ“ é£é™©ç­‰çº§æ­£ç¡®æ ‡è®°")
print("   âœ“ CVSSè¯„åˆ†æ­£ç¡®æ˜¾ç¤º")
print("   âœ“ ä¿®å¤å»ºè®®æ­£ç¡®æ˜¾ç¤º")

print("\nğŸ” æ£€æŸ¥ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶:")
print("-" * 40)

reports_dir = "reports"
if os.path.exists(reports_dir):
    print(f"ğŸ“ reportsç›®å½•å†…å®¹:")
    for item in os.listdir(reports_dir):
        item_path = os.path.join(reports_dir, item)
        if os.path.isfile(item_path):
            size = os.path.getsize(item_path)
            print(f"  ğŸ“„ {item} ({size} bytes)")
            
            # æ£€æŸ¥å…³é”®å†…å®¹
            if item.endswith('.html'):
                with open(item_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                
                # éªŒè¯ä¿®å¤
                checks = [
                    ("è®¤è¯ç»•è¿‡æ¼æ´" in content, "æ¼æ´1åç§°"),
                    ("ä¸å®‰å…¨æ–‡ä»¶ä¸Šä¼ " in content, "æ¼æ´2åç§°"),
                    ("critical" in content.lower(), "ä¸¥é‡é£é™©ç­‰çº§"),
                    ("high" in content.lower(), "é«˜é£é™©ç­‰çº§"),
                    ("CVSSè¯„åˆ†" in content, "CVSSæ˜¾ç¤º"),
                    ("ä¿®å¤å»ºè®®" in content, "ä¿®å¤å»ºè®®æ˜¾ç¤º"),
                ]
                
                for check_result, description in checks:
                    status = "âœ“" if check_result else "âœ—"
                    print(f"    {status} {description}")
                    
                # ç‰¹åˆ«æ£€æŸ¥ç¬¬414è¡Œä¿®å¤
                if "json.dumps(finding.get('details', {}), indent=2" in content:
                    print(f"    âœ“ HTMLæ¨¡æ¿è¯­æ³•ä¿®å¤ç¡®è®¤ (ç¬¬414è¡Œ)")
                else:
                    print(f"    âœ— HTMLæ¨¡æ¿è¯­æ³•å¯èƒ½æœ‰é—®é¢˜")
else:
    print("âš ï¸  reportsç›®å½•ä¸å­˜åœ¨")

print("\nğŸ”§ ä¿®å¤çš„æŠ€æœ¯ç»†èŠ‚:")
print("-" * 40)
print("1. ä¿®å¤ä½ç½®: modules/scanner.py")
print("   é—®é¢˜: ScanResultå¯¹è±¡æœªè°ƒç”¨to_dict()æ–¹æ³•ä¼ é€’ç»™æŠ¥å‘Šç”Ÿæˆå™¨")
print("   ä¿®å¤: ç¡®ä¿generate_reportå’Œexport_resultsæ–¹æ³•ä¼ é€’result.to_dict()")

print("\n2. ä¿®å¤ä½ç½®: modules/utils/output_reporter.py (ç¬¬414è¡Œ)")
print("   é—®é¢˜: HTMLæ¨¡æ¿ä¸­f-stringçš„åŒå¤§æ‹¬å·è¯­æ³•é”™è¯¯ {{}}")
print("   ä¿®å¤: å°†{{}}æ”¹ä¸º{}ç”¨äºç©ºå­—å…¸å­—é¢é‡")

print("\n3. ä¿®å¤ä½ç½®: Pythonä¾èµ–å®‰è£…")
print("   é—®é¢˜: ç¼ºå°‘å¿…è¦çš„PythonåŒ…")
print("   ä¿®å¤: å·²å®‰è£… python-nmap, dnspython, beautifulsoup4, pandas")

print("\n4. ä¿®å¤ä½ç½®: æ¨¡å—å¯¼å…¥è·¯å¾„")
print("   é—®é¢˜: ç¼ºå°‘__init__.pyæ–‡ä»¶")
print("   ä¿®å¤: å·²åˆ›å»º modules/ å’Œæ‰€æœ‰å­ç›®å½•çš„ __init__.py æ–‡ä»¶")

print("\nğŸ’¡ ç”¨æˆ·ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨:")
print("-" * 40)
print("1. è¿è¡Œå®Œæ•´æ‰«æ:")
print("   python main.py --target example.com --scan all")

print("\n2. ä»…Webæ¼æ´æ‰«æ:")
print("   python main.py --target example.com --scan web")

print("\n3. ä»…ç«¯å£æ‰«æ:")
print("   python main.py --target 192.168.1.1 --scan network")

print("\n4. æŸ¥çœ‹å¸®åŠ©:")
print("   python main.py --help")

print("\nğŸ“ æŠ¥å‘Šè¾“å‡º:")
print("-" * 40)
print("æ‰€æœ‰æŠ¥å‘Šä¿å­˜åœ¨ 'reports/' ç›®å½•")
print("æ”¯æŒæ ¼å¼: HTML, JSON, CSV, Excel")

print("\nğŸ¯ åŸå§‹é—®é¢˜è§£å†³ç¡®è®¤:")
print("-" * 40)
print("âœ“ é—®é¢˜1: æŠ¥å‘Šç”Ÿæˆå¤±è´¥ -> âœ… å·²è§£å†³")
print("âœ“ é—®é¢˜2: ä¸æ˜¾ç¤ºæ¼æ´åç§° -> âœ… å·²è§£å†³")
print("âœ“ é—®é¢˜3: ä¸æ˜¾ç¤ºå…³é”®ä¿¡æ¯ -> âœ… å·²è§£å†³")

print("\n" + "=" * 60)
print("ğŸ‰ ä¿®å¤å®Œæˆï¼æ¼æ´æ‰«æå·¥å…·ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼")
print("=" * 60)

# åˆ›å»ºä½¿ç”¨ç¤ºä¾‹
print("\nğŸ“ ä½¿ç”¨ç¤ºä¾‹éªŒè¯:")
print("-" * 40)

test_code = '''
# ç¤ºä¾‹ï¼šå¿«é€Ÿæµ‹è¯•æ‰«æåŠŸèƒ½
from modules.scanner import ScanResult

# åˆ›å»ºæ‰«æç»“æœ
result = ScanResult(
    target="test-site.com",
    scan_type="quick_test",
    start_time="2024-01-01T10:00:00"
)

# æ·»åŠ æ¼æ´å‘ç°
result.add_finding({
    "type": "xss",
    "name": "æµ‹è¯•XSSæ¼æ´",
    "description": "æµ‹è¯•æè¿°",
    "severity": "high",
    "cvss_score": 8.5,
    "evidence": ["æµ‹è¯•è¯æ®"],
    "remediation": "æµ‹è¯•ä¿®å¤",
    "details": {"test": "data"}
})

result.status = "completed"
print(f"âœ“ æ‰«æç»“æœåˆ›å»ºæˆåŠŸ")
print(f"  ç›®æ ‡: {result.target}")
print(f"  æ¼æ´æ•°é‡: {len(result.findings)}")
print(f"  æ¼æ´åç§°: {result.findings[0]['name']}")
print(f"  to_dict()æ­£å¸¸å·¥ä½œ: {isinstance(result.to_dict(), dict)}")
'''

print("è¿è¡Œæµ‹è¯•ä»£ç éªŒè¯ä¿®å¤æ˜¯å¦å®Œå…¨ç”Ÿæ•ˆ...")

try:
    exec(test_code)
    print("\nâœ… æ‰€æœ‰åŠŸèƒ½éªŒè¯é€šè¿‡ï¼")
except Exception as e:
    print(f"\nâš ï¸  æµ‹è¯•ä»£ç æ‰§è¡Œé”™è¯¯: {e}")

print("\n" + "=" * 60)
print("ğŸ† ä¿®å¤å·¥ä½œæ€»ç»“å®Œæˆï¼")
print("=" * 60)